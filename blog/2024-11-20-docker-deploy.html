<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker 部署深度学习模型最佳实践 - 熊发展的技术博客</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/common.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>

<body class="antialiased min-h-screen flex flex-col">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <a href="../index.html" class="flex items-center space-x-4 hover:opacity-80 transition-opacity">
                <div class="h-10 w-10 bg-teal-700 rounded-full flex items-center justify-center text-white font-bold shadow-md">
                    熊
                </div>
                <span class="font-bold text-stone-800">返回首页</span>
            </a>
            <a href="../blog.html" class="text-sm text-stone-600 hover:text-teal-700 transition-colors">
                <i class="fas fa-arrow-left mr-1"></i>返回博客列表
            </a>
        </div>
    </header>

    <main class="flex-grow max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12 w-full">

        <article>
            <header class="mb-8">
                <div class="flex items-center gap-2 mb-4">
                    <span class="px-3 py-1 bg-purple-50 text-purple-700 text-sm rounded">工程化</span>
                    <span class="text-sm text-stone-400">2024-11-20</span>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-stone-800 mb-4">Docker 部署深度学习模型最佳实践</h1>
                <p class="text-lg text-stone-600">从 Dockerfile 编写到多阶段构建优化，打造生产级 AI 服务镜像。</p>
            </header>

            <div class="prose prose-stone max-w-none">
                <h2 class="text-2xl font-bold text-stone-800 mt-8 mb-4">一、为什么需要 Docker？</h2>
                <p class="text-stone-600 leading-relaxed mb-4">
                    深度学习模型部署常面临环境依赖复杂、版本冲突、难以迁移等问题。Docker 通过容器化技术解决了这些痛点：
                </p>
                <ul class="list-disc list-inside text-stone-600 space-y-2 mb-4">
                    <li><strong>环境一致性</strong>：开发、测试、生产环境完全一致</li>
                    <li><strong>快速部署</strong>：一条命令启动服务</li>
                    <li><strong>资源隔离</strong>：独立运行，互不干扰</li>
                    <li><strong>易于扩展</strong>：配合 Kubernetes 实现弹性伸缩</li>
                </ul>

                <h2 class="text-2xl font-bold text-stone-800 mt-8 mb-4">二、基础 Dockerfile</h2>

                <h3 class="text-xl font-semibold text-stone-800 mt-6 mb-3">2.1 最小化示例</h3>
                <div class="bg-stone-800 rounded-lg p-4 my-6 overflow-x-auto">
                    <pre><code class="language-dockerfile"># 使用官方 Python 基础镜像
FROM python:3.10-slim

# 设置工作目录
WORKDIR /app

# 复制依赖文件
COPY requirements.txt .

# 安装依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-stone-800 mt-6 mb-3">2.2 requirements.txt</h3>
                <div class="bg-stone-800 rounded-lg p-4 my-6 overflow-x-auto">
                    <pre><code class="language-python">fastapi==0.104.1
uvicorn[standard]==0.24.0
torch==2.1.0
torchvision==0.16.0
transformers==4.35.0
pillow==10.1.0
numpy==1.24.3
pydantic==2.5.0</code></pre>
                </div>

                <h2 class="text-2xl font-bold text-stone-800 mt-8 mb-4">三、多阶段构建优化</h2>

                <h3 class="text-xl font-semibold text-stone-800 mt-6 mb-3">3.1 为什么需要多阶段构建？</h3>
                <p class="text-stone-600 leading-relaxed mb-4">
                    深度学习镜像通常很大（数 GB），多阶段构建可以：
                </p>
                <ul class="list-disc list-inside text-stone-600 space-y-2 mb-4">
                    <li>分离构建依赖和运行依赖</li>
                    <li>最终镜像只包含运行时必需文件</li>
                    <li>大幅减小镜像体积</li>
                </ul>

                <h3 class="text-xl font-semibold text-stone-800 mt-6 mb-3">3.2 优化后的 Dockerfile</h3>
                <div class="bg-stone-800 rounded-lg p-4 my-6 overflow-x-auto">
                    <pre><code class="language-dockerfile"># ==================== 阶段1：构建 ====================
FROM python:3.10-slim as builder

# 安装构建依赖
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# 复制并安装依赖（只安装生产依赖）
COPY requirements.txt .
RUN pip install --user --no-cache-dir -r requirements.txt

# ==================== 阶段2：运行 ====================
FROM python:3.10-slim as runtime

# 安装运行时依赖（如 OpenCV 需要的库）
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# 从构建阶段复制已安装的包
COPY --from=builder /root/.local /root/.local

# 设置 PATH 确保能找到安装的包
ENV PATH=/root/.local/bin:$PATH

WORKDIR /app

# 复制应用代码
COPY . .

# 创建非 root 用户
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser

# 暴露端口
EXPOSE 8000

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# 启动命令
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]</code></pre>
                </div>

                <h2 class="text-2xl font-bold text-stone-800 mt-8 mb-4">四、进一步优化技巧</h2>

                <h3 class="text-xl font-semibold text-stone-800 mt-6 mb-3">4.1 缓存层优化</h3>
                <div class="bg-stone-800 rounded-lg p-4 my-6 overflow-x-auto">
                    <pre><code class="language-dockerfile"># 按照缓存友好的顺序组织指令
# 1. 先复制依赖文件（很少变动）
COPY requirements.txt .
RUN pip install -r requirements.txt

# 2. 再复制代码（经常变动）
COPY . .

# 这样代码修改时，依赖安装层会被缓存复用</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-stone-800 mt-6 mb-3">4.2 使用 .dockerignore</h3>
                <p class="text-stone-600 leading-relaxed mb-4">排除不必要的文件：</p>
                <div class="bg-stone-800 rounded-lg p-4 my-6 overflow-x-auto">
                    <pre><code class="language-text"># .dockerignore
__pycache__
*.pyc
*.pyo
*.pyd
.git
.gitignore
.env
venv/
.venv/
*.md
tests/
.pytest_cache/
*.egg-info/
dist/
build/
models/  # 如果模型文件太大，考虑使用挂载</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-stone-800 mt-6 mb-3">4.3 模型文件处理</h3>
                <p class="text-stone-600 leading-relaxed mb-4">模型文件通常很大，有几种处理方式：</p>
                <div class="bg-stone-800 rounded-lg p-4 my-6 overflow-x-auto">
                    <pre><code class="language-bash"># 方式1：构建时下载（适合公开模型）
RUN wget -O /app/models/yolo.pt https://github.com/.../yolo.pt

# 方式2：运行时下载（适合需要更新的模型）
# 在应用启动时下载

# 方式3：Volume 挂载（推荐）
# 构建时不包含模型，运行时挂载
docker run -v /host/models:/app/models:ro myimage</code></pre>
                </div>

                <h2 class="text-2xl font-bold text-stone-800 mt-8 mb-4">五、GPU 支持</h2>

                <h3 class="text-xl font-semibold text-stone-800 mt-6 mb-3">5.1 使用 nvidia-docker</h3>
                <div class="bg-stone-800 rounded-lg p-4 my-6 overflow-x-auto">
                    <pre><code class="language-dockerfile"># 使用 NVIDIA CUDA 基础镜像
FROM nvidia/cuda:11.8.0-runtime-ubuntu22.04

# 安装 Python
RUN apt-get update && apt-get install -y \
    python3.10 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# 后续步骤与普通 Dockerfile 类似
# ...</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-stone-800 mt-6 mb-3">5.2 运行 GPU 容器</h3>
                <div class="bg-stone-800 rounded-lg p-4 my-6 overflow-x-auto">
                    <pre><code class="language-bash"># 使用 --gpus 参数
docker run --gpus all -p 8000:8000 myimage

# 指定特定 GPU
docker run --gpus '"device=0,1"' -p 8000:8000 myimage

# 限制 GPU 内存
docker run --gpus device=0,device=1 \
    --shm-size=1g \
    -p 8000:8000 \
    myimage</code></pre>
                </div>

                <h2 class="text-2xl font-bold text-stone-800 mt-8 mb-4">六、构建与运行</h2>

                <h3 class="text-xl font-semibold text-stone-800 mt-6 mb-3">6.1 构建镜像</h3>
                <div class="bg-stone-800 rounded-lg p-4 my-6 overflow-x-auto">
                    <pre><code class="language-bash"># 构建镜像
docker build -t my-model-service:latest .

# 查看镜像大小
docker images my-model-service

# 优化：使用 BuildKit
DOCKER_BUILDKIT=1 docker build -t my-model-service .</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-stone-800 mt-6 mb-3">6.2 运行容器</h3>
                <div class="bg-stone-800 rounded-lg p-4 my-6 overflow-x-auto">
                    <pre><code class="language-bash"># 基本运行
docker run -d -p 8000:8000 --name myservice my-model-service

# 挂载模型文件
docker run -d \
    -p 8000:8000 \
    -v /path/to/models:/app/models:ro \
    --name myservice \
    my-model-service

# 设置环境变量
docker run -d \
    -p 8000:8000 \
    -e MODEL_PATH=/app/models/yolo.pt \
    -e LOG_LEVEL=info \
    --name myservice \
    my-model-service

# 资源限制
docker run -d \
    -p 8000:8000 \
    --memory=4g \
    --cpus=2 \
    --name myservice \
    my-model-service</code></pre>
                </div>

                <h2 class="text-2xl font-bold text-stone-800 mt-8 mb-4">七、Docker Compose（推荐）</h2>
                <p class="text-stone-600 leading-relaxed mb-4">使用 Docker Compose 管理多服务应用：</p>
                <div class="bg-stone-800 rounded-lg p-4 my-6 overflow-x-auto">
                    <pre><code class="language-yaml"># docker-compose.yml
version: '3.8'

services:
  model-api:
    build: .
    image: my-model-service:latest
    container_name: model-api
    ports:
      - "8000:8000"
    volumes:
      - ./models:/app/models:ro
      - ./logs:/app/logs
    environment:
      - MODEL_PATH=/app/models/yolo.pt
      - LOG_LEVEL=info
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
        reservations:
          memory: 2G
          cpus: '1'
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - model-api
    restart: unless-stopped</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-stone-800 mt-6 mb-3">7.2 使用 Compose</h3>
                <div class="bg-stone-800 rounded-lg p-4 my-6 overflow-x-auto">
                    <pre><code class="language-bash"># 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f model-api

# 停止服务
docker-compose down

# 重启服务
docker-compose restart model-api</code></pre>
                </div>

                <h2 class="text-2xl font-bold text-stone-800 mt-8 mb-4">八、生产环境检查清单</h2>

                <div class="bg-white rounded-lg shadow-sm p-6 my-6 border border-stone-200">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2">项目</th>
                                <th class="text-left py-2">检查项</th>
                                <th class="text-left py-2">状态</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="py-2">安全性</td>
                                <td class="py-2">使用非 root 用户运行</td>
                                <td class="py-2">✓</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-2">安全性</td>
                                <td class="py-2">敏感信息使用环境变量</td>
                                <td class="py-2">✓</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-2">性能</td>
                                <td class="py-2">多阶段构建减小镜像</td>
                                <td class="py-2">✓</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-2">性能</td>
                                <td class="py-2">设置资源限制</td>
                                <td class="py-2">✓</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-2">可靠性</td>
                                <td class="py-2">健康检查配置</td>
                                <td class="py-2">✓</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-2">可靠性</td>
                                <td class="py-2">自动重启策略</td>
                                <td class="py-2">✓</td>
                            </tr>
                            <tr class="border-b">
                                <td class="py-2">可维护性</td>
                                <td class="py-2">日志持久化</td>
                                <td class="py-2">✓</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h2 class="text-2xl font-bold text-stone-800 mt-8 mb-4">九、总结</h2>
                <p class="text-stone-600 leading-relaxed mb-4">
                    Docker 容器化是深度学习模型部署的最佳实践之一。通过多阶段构建、合理配置资源限制、使用 Docker Compose 管理服务，可以构建出生产级、高可用的 AI 服务。记住：
                </p>
                <ul class="list-disc list-inside text-stone-600 space-y-2 mb-4">
                    <li><strong>镜像越小越好</strong>：减少传输和存储成本</li>
                    <li><strong>分层清晰</strong>：利用缓存加速构建</li>
                    <li><strong>安全第一</strong>：最小权限原则</li>
                    <li><strong>可观测性</strong>：日志、健康检查一个都不能少</li>
                </ul>
            </div>

            <footer class="mt-12 pt-8 border-t border-stone-200">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-2 text-sm text-stone-500">
                        <i class="fas fa-tags"></i>
                        <span>标签: </span>
                        <span class="px-2 py-1 bg-stone-100 rounded">Docker</span>
                        <span class="px-2 py-1 bg-stone-100 rounded">部署</span>
                        <span class="px-2 py-1 bg-stone-100 rounded">DevOps</span>
                    </div>
                </div>
            </footer>
        </article>

        <nav class="mt-12 pt-8 border-t border-stone-200">
            <div class="grid grid-cols-2 gap-4">
                <a href="../blog/2024-11-28-qwen-vl.html" class="p-4 bg-white rounded-lg shadow-sm hover:shadow-md transition-all border border-stone-100">
                    <p class="text-xs text-stone-400 mb-1">下一篇</p>
                    <p class="font-semibold text-stone-800 hover:text-teal-700">Qwen-VL 多模态应用实战</p>
                </a>
                <span class="p-4 bg-stone-50 rounded-lg border border-stone-100 text-right">
                    <p class="text-xs text-stone-400 mb-1">上一篇</p>
                    <p class="font-semibold text-stone-400">没有更多文章了</p>
                </span>
            </div>
        </nav>

    </main>

    <footer class="bg-stone-800 text-stone-300 py-8 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-sm mb-4">感谢阅读！欢迎留言交流</p>
            <p class="text-xs text-stone-500">© 2024 熊发展. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            hljs.highlightAll();
        });
    </script>
</body>

</html>
